(function(scope,$){scope.GameLogic={};var gameLogic=function(){slotArray=[];initGame();}
var countUpMainPrize;var moneyWinInterval;var bgWinInterval;var timeOutRepeatLine;gameLogic.prototype.JoinGame=function(data){GameAudio.Play("Music.BGM.MainGame",0.35,1);App.CD2AccInfo=data;if(data){Config.IsTry=data.IsPlayTry;Config.IsAutoSpin=data.AutoSpin;Config.IsAutoByServer=data.IsAutoByServer;Config.TotalAutoSpin=data.TotalAutoSpin;}
if(data.SlotInfo){var slotInfo=data.SlotInfo;Config.RoomId=slotInfo.RoomID===0?1:slotInfo.RoomID;Config.RoomValue=roomValue[Config.RoomId];Config.TotalFreeSpin=slotInfo.FreeSpins;Config.CanPlayBonus=slotInfo.CanPlayBonusGame;Config.CanPlayDouble=slotInfo.CanPlayX2Game;Config.IsInDouble=slotInfo.Game_Status==2;GuiContents.UpdateRoom();var balance=data.Account.TotalStar>0?data.Account.TotalStar:(data.X2Game.Balance>0?data.X2Game.Balance:App.Game.getBalanceFromHeader());App.Game.UpdateBalance(App.Game.getCurrentBalance(),balance);if(Config.IsTry){App.Game.UpdateJackpot(slotInfo.Jackpot);}
if(Config.CanPlayDouble){App.Game.UpdateLastPrize(data.X2Game.StartBetValue);if(balance<data.X2Game.StartBetValue){Config.CanPlayDouble=false;}}else{App.Game.UpdateLastPrize(slotInfo.LastPrizeValues);}}
if(Config.IsAutoByServer){if(Config.TotalFreeSpin>0){GuiContents.ShowFreeSpin();GuiContents.UpdateFreeSpin(Config.TotalFreeSpin);}
if(Config.TotalAutoSpin>0){GuiContents.ShowPopup("Bạn đang trong chế độ quay tự động trên Server.</br> Bấm nút <b>DỪNG</b> để dừng lại!",null,2);GuiContents.UnbindEvents();}else{App.gameHub.server.SetAutoSpin(false,0,Config.RoomValue,false,null);GuiContents.HidePopup();GuiContents.BindEvents();}
GuiContents.AutoSpin();}else{if((Config.IsAutoSpin&&Config.TotalAutoSpin>0)||Config.TotalFreeSpin>0){if(Config.TotalFreeSpin>0){GuiContents.ShowFreeSpin();GuiContents.UpdateFreeSpin(Config.TotalFreeSpin);}
GuiContents.AutoSpin();}
GuiContents.UpdateAutoSpin(Config.TotalAutoSpin);if(Config.CanPlayBonus){App.Game.ShowBonusEffect(function(){App.gameHub.server.GetBonusGame();});}
if(Config.IsInDouble){GuiContents.ShowX2Game();}}
GuiContents.BindEvents();}
gameLogic.prototype.ResultSpin=function(data){App.CD2AccInfo=data;var slot=[[],[],[],[],[]];var slotData=data.SpinData.Slots;if(slotData&&slotData.length==15){for(var i=0;i<15;i++){slot[i%5].push(+slotData[i]);}
Config.IsShowPanel=false;Config.IsAutoSpin=data.AutoSpin;Config.IsAutoByServer=data.IsAutoByServer;Config.TotalAutoSpin=data.TotalAutoSpin<0?0:data.TotalAutoSpin;Config.CanPlayDouble=data.SlotInfo.CanPlayX2Game;GuiContents.UpdateAutoSpin(Config.TotalAutoSpin);App.Game.ClearAllTimeout();if(Config.IsAutoByServer){if(data.SlotInfo.FreeSpins>0){if(Config.TotalFreeSpin<data.SlotInfo.FreeSpins){GuiContents.ShowFreeSpin();Config.TotalFreeSpin=data.SlotInfo.FreeSpins;GuiContents.UpdateFreeSpin(Config.TotalFreeSpin);}else{Config.TotalFreeSpin=data.SlotInfo.FreeSpins;GuiContents.UpdateFreeSpin(Config.TotalFreeSpin);}}else if(Config.TotalFreeSpin>0){GuiContents.HideFreeSpin();Config.TotalFreeSpin=data.SlotInfo.FreeSpins;}
Config.CurrentState=0;showSpinResult(data);if(Config.TotalAutoSpin>0){GuiContents.UnbindEvents();}else{App.gameHub.server.SetAutoSpin(false,0,Config.RoomValue,false,null);GuiContents.HidePopup();GuiContents.BindEvents();}
GuiContents.AutoSpin();}else{App.Game.RerenderItem();Config.CurrentState=2;itemContainer.SpinAnimation(slot,function(){GuiContents.UpdateAutoSpin(Config.TotalAutoSpin);App.Game.RenderWinItemEffect(data,slot,App.Game.RerenderItem);Config.CurrentState=3;Config.CanPlayDouble=data.SlotInfo.CanPlayX2Game;checkPrize(data);});slotArray=slot;}}else{GuiContents.ShowPopup("Rất tiếc hệ thống đang bận, vui lòng thử lại sau!");GuiContents.BindEvents();}}
gameLogic.prototype.RenderWinItemEffect=function(data,slot,callback){var prizeLines=data.SpinData.PrizeLines;if(prizeLines&&prizeLines.length>0){GameAudio.Play('Sound.Win');App.Game.RenderAllLineWin(data,prizeLines);if(timeoutLineWin){clearTimeout(timeoutLineWin);delete timeoutLineWin;}
timeoutLineWin=setTimeout(function(){if(callback){callback();}},2000);itemContainer.DrawSlotItemEffect(slot,data.SpinData.PrizeLines);}else{if(callback){callback();}}}
gameLogic.prototype.RenderAllLineWin=function(data,prizeLines){if(prizeLines&&prizeLines.length>0){$.each(prizeLines,function(index,line){App.Game.RenderLineWin(data,line);});}}
gameLogic.prototype.RenderLineWin=function(data,lineWin,callback){if(lineWin&&lineWin.Items){var items=[];$.each(lineWin.Items,function(item){items.push(item);});items=CommonUtility.UniqueArrays(items).map(function(val){return+val;});for(var row=0;row<3;row++){for(var col=0;col<5;col++){var curItem=row*5+col+1;if(items.indexOf(curItem)>-1){var icon=Common.GetSprite(App.gameResources.getResourceItem('spritesheet.WinEffect'),"ItemAn");var bound=icon.getBounds();icon.set({x:bound.width/2*0.5-18,y:bound.height/2*0.5+45+row*160-18,regX:bound.width/2,regY:bound.height/2,scaleX:0.9,scaleY:0.9,name:"ItemWinEffect_"+curItem});icon.on("animationend",function(target){target.target.parent.removeChild(target.currentTarget);});itemContainer.children[col].addChild(icon);}}}
for(var col=0;col<5;col++){$.each(itemContainer.children[col].children,function(key,value){if(value.name=='icon1-2'||value.name=='icon1-3'){value.parent.setChildIndex(value,value.parent.children.length-1)}})}
if(timeoutLineWin){clearTimeout(timeoutLineWin);delete timeoutLineWin;}
timeoutLineWin=setTimeout(function(){if(callback){callback();}},2000);}else{if(callback)
callback();}}
gameLogic.prototype.RepeatLineWin=function(data,prizeLines,index){if(prizeLines&&prizeLines.length>0){if(index>=prizeLines.length){index=0;}
App.Game.RenderLineWin(data,prizeLines[index],function(){App.Game.RepeatLineWin(data,prizeLines,index+1);});}}
gameLogic.prototype.RerenderItem=function(){clearCanvas(false);renderItem();}
var canStop=true;gameLogic.prototype.StopSpin=function(){if(canStop){canStop=false;App.Game.RerenderItem();Config.CurrentState=3;Config.CanPlayDouble=App.CD2AccInfo.SlotInfo.CanPlayX2Game;GuiContents.UpdateAutoSpin(Config.TotalAutoSpin);canStop=true;checkPrize(App.CD2AccInfo);}}
gameLogic.prototype.ClearAllTimeout=function(){if(timeoutLineWin){clearTimeout(timeoutLineWin);delete timeoutLineWin;}
if(timeoutRepeat){clearTimeout(timeoutRepeat);delete timeoutRepeat;}
if(intervalLineWin){clearInterval(intervalLineWin);delete intervalLineWin;}}
gameLogic.prototype.UpdateJackpot=function(jackpot){var currJackpot=CommonUtility.parseIntMoney($('#jackpotAvenger').text());if(jackpot!==currJackpot){var countUpJackpot=new CDCountUp(null,currJackpot,jackpot,0,2.5,options,function(value){$('#jackpotAvenger').text(CommonUtility.formatMoney(value));});countUpJackpot.start();}}
gameLogic.prototype.UpdateJackpotHunter=function(jackpot,roomId){var currJackpot=CommonUtility.parseIntMoney($('#jackpotHunterValueRoom'+roomId).text());if(jackpot!==currJackpot){var countUpJackpot=new CDCountUp(null,currJackpot,jackpot,0,2.5,options,function(value){$('#jackpotHunterValueRoom'+roomId).text(CommonUtility.formatMoney(value));});countUpJackpot.start();}}
gameLogic.prototype.UpdateBalance=function(currrentBalance,balance){if(currrentBalance>=0&&balance>=0){var countUpBalance=new CDCountUp(null,currrentBalance,balance,0,1,options,function(value){$('#totalBalanceAvenger').text(CommonUtility.formatMoney(value));});countUpBalance.start();}
if(!Config.IsTry){GlobalHeader.UpdateRealCoinBalance(balance);}}
gameLogic.prototype.UpdateLastPrize=function(prize){var countUpPrize=new CDCountUp(null,0,prize,0,1,options,function(value){$('#totalWinAvenger').text(CommonUtility.formatMoney(value));});countUpPrize.start();}
gameLogic.prototype.ShowPrizeSmallWin=function(prize,callback){if(prize>0){if(moneyWinInterval){clearInterval(moneyWinInterval);delete moneyWinInterval;}
moneyWinInterval=setInterval(function(){if($('.list_items .effect_thangthuong img').last().hasClass('active')){$('.list_items .effect_thangthuong img.active').removeClass('active');$('.list_items .effect_thangthuong img').first().addClass('active');}else{$('.list_items .effect_thangthuong img.active').removeClass('active').next().addClass('active');}},60);$(".moneyWinAvenger").show();$("#effectWinAvenger").show();$("#effectSmallWinAvenger").show();$("#effectWinContentAvenger").hide();if(countUpMainPrize){countUpMainPrize.pauseResume();delete countUpMainPrize;}
countUpMainPrize=new CDCountUp(null,0,prize,0,0.8,options,function(value){$(".moneyWinContentAvenger").html(CommonUtility.formatMoney(value));});setTimeout(function(){$(".moneyWinAvenger").hide();$(".moneyWinContentAvenger").html("0");$("#effectWinAvenger").hide();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").hide();if(moneyWinInterval){clearInterval(moneyWinInterval);delete moneyWinInterval;}
if(callback){callback();}},1800);countUpMainPrize.start();}else{$(".moneyWinContentAvenger").html("0");if(callback){callback();}}}
gameLogic.prototype.ShowPrizeBigWin=function(prize,callback){if(prize>0){$.ajax({type:"GET",url:Config.Url.ROOT+'Home/BigWin',crossDomain:true,xhrFields:{withCredentials:true},success:function(data){$('#effectWinContentAvenger').html(data);if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
bgWinInterval=setInterval(function(){if($('.effect_thang .bg_effect img').last().hasClass('active')){$('.effect_thang .bg_effect img.active').removeClass('active');$('.effect_thang .bg_effect img').first().addClass('active');}else{$('.effect_thang .bg_effect img.active').removeClass('active').next().addClass('active');}},50);if(moneyWinInterval){clearInterval(moneyWinInterval);delete moneyWinInterval;}
moneyWinInterval=setInterval(function(){if($('.effect_thang .xutung img').last().hasClass('active')){$('.effect_thang .xutung img.active').removeClass('active');$('.effect_thang .xutung img').first().addClass('active');}else{$('.effect_thang .xutung img.active').removeClass('active').next().addClass('active');}},50);},fail:function(fail){console.log(fail);}});$("#effectWinAvenger").show();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").show();if(countUpMainPrize){countUpMainPrize.pauseResume();delete countUpMainPrize;}
countUpMainPrize=new CDCountUp(null,0,prize,0,3,options,function(value){$(".moneyWinContentAvenger").html(CommonUtility.formatMoney(value));});countUpMainPrize.start();setTimeout(function(){$("#effectWinAvenger").hide();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").hide();$("#effectWinContentAvenger").html("");if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
if(moneyWinInterval){clearInterval(moneyWinInterval);delete moneyWinInterval;}
if(callback){callback();}},5000);}else{$(".moneyWinContentAvenger").html("0");if(callback){callback();}}}
gameLogic.prototype.ShowPrizeMegaWin=function(prize,callback){if(prize>0){$.ajax({type:"GET",url:Config.Url.ROOT+'Home/MegaWin',crossDomain:true,xhrFields:{withCredentials:true},success:function(data){$('#effectWinContentAvenger').html(data);if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
bgWinInterval=setInterval(function(){if($('.effect_thang .bg_effect img').last().hasClass('active')){$('.effect_thang .bg_effect img.active').removeClass('active');$('.effect_thang .bg_effect img').first().addClass('active');}else{$('.effect_thang .bg_effect img.active').removeClass('active').next().addClass('active');}},50);if(moneyWinInterval){clearInterval(moneyWinInterval);delete moneyWinInterval;}
moneyWinInterval=setInterval(function(){if($('.effect_thang .xutung img').last().hasClass('active')){$('.effect_thang .xutung img.active').removeClass('active');$('.effect_thang .xutung img').first().addClass('active');}else{$('.effect_thang .xutung img.active').removeClass('active').next().addClass('active');}},50);},fail:function(fail){console.log(fail);}});$("#effectWinAvenger").show();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").show();if(countUpMainPrize){countUpMainPrize.pauseResume();delete countUpMainPrize;}
countUpMainPrize=new CDCountUp(null,0,prize,0,3,options,function(value){$(".moneyWinContentAvenger").html(CommonUtility.formatMoney(value));});countUpMainPrize.start();setTimeout(function(){$("#effectWinAvenger").hide();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").hide();$("#effectWinContentAvenger").html("");if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
if(moneyWinInterval){clearInterval(moneyWinInterval);delete moneyWinInterval;}
if(callback){callback();}},5000);}else{$(".moneyWinContentAvenger").html("0");if(callback){callback();}}}
gameLogic.prototype.ShowBonusEffect=function(callback){$.ajax({type:"GET",url:Config.Url.ROOT+'Home/BonusWin',crossDomain:true,xhrFields:{withCredentials:true},success:function(data){$('#effectWinContentAvenger').html(data);if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
bgWinInterval=setInterval(function(){if($('.effect_thang .bg_effect img').last().hasClass('active')){$('.effect_thang .bg_effect img.active').removeClass('active');$('.effect_thang .bg_effect img').first().addClass('active');}else{$('.effect_thang .bg_effect img.active').removeClass('active').next().addClass('active');}},50);$("#effectWinAvenger").show();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").show();setTimeout(function(){$("#effectWinAvenger").hide();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").hide();$("#effectWinContentAvenger").html("");if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
if(callback)
callback();},3000);},fail:function(fail){console.log(fail);}});}
gameLogic.prototype.ShowFreeSpinEffect=function(totalFreeSpin,callback){$.ajax({type:"GET",url:Config.Url.ROOT+'Home/FreeSpin',crossDomain:true,xhrFields:{withCredentials:true},success:function(data){$('#effectWinContentAvenger').html(data);if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
bgWinInterval=setInterval(function(){if($('.effect_thang .bg_effect img').last().hasClass('active')){$('.effect_thang .bg_effect img.active').removeClass('active');$('.effect_thang .bg_effect img').first().addClass('active');}else{$('.effect_thang .bg_effect img.active').removeClass('active').next().addClass('active');}},50);$("#totalFreeSpinAvenger").html(totalFreeSpin+" Lượt");$("#effectWinAvenger").show();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").show();setTimeout(function(){$("#effectWinAvenger").hide();$("#effectSmallWinAvenger").hide();$("#effectWinContentAvenger").hide();$("#effectWinContentAvenger").html("");if(bgWinInterval){clearInterval(bgWinInterval);delete bgWinInterval;}
if(callback)
callback();},3000);},fail:function(fail){console.log(fail);}});}
gameLogic.prototype.ShowResultFreeSpin=function(totalFreeSpinMonet,callback){GuiContents.ShowPopup("Kết thúc lượt quay miễn phí. Bạn nhận được "+
CommonUtility.formatMoney(totalFreeSpinMonet)+
" Vgold!");$('#popupMessageAvenger').unbind('click');$('#popupMessageAvenger').click(function(){GuiContents.HidePopup();if(timeoutPopup){clearTimeout(timeoutPopup);}
if(callback){callback();}});if(Config.IsAutoSpin>0){if(timeoutPopup){clearTimeout(timeoutPopup);}
timeoutPopup=setTimeout(function(){GuiContents.HidePopup();if(callback){callback();}},2000);}}
gameLogic.prototype.getCurrentBalance=function(){var currBalance=CommonUtility.parseIntMoney($('#totalBalanceAvenger').text());if(currBalance<=0){currBalance=App.Game.getBalanceFromHeader();}
return currBalance;}
gameLogic.prototype.getBalanceFromHeader=function(){var currBalance=CommonUtility.parseIntMoney($('#headerRealCoinValue').text());if(currBalance<=0){currBalance=0;}
return currBalance;}
var initGame=function(){clearCanvas(true);renderItem();};var clearCanvas=function(first){if(itemContainer){createjs.Tween.removeTweens(itemContainer);itemContainer.removeAllChildren();delete itemContainer;gameStage.removeAllChildren();}
if(first){slotArray=[[],[],[],[],[]];slotArray.forEach(function(col){for(var i=0;i<3;i++){col.push(randomIconNumber());}});gameStage=new createjs.Stage("canvasAvenger");gameStage.setBounds(0,0,$('#canvasAvenger').width(),$('#canvasAvenger').height());createjs.Ticker.framerate=24;createjs.Ticker.addEventListener("tick",function(event){if(gameStage)
gameStage.update(event);});}}
var randomIconNumber=function(){var random=Math.random();if(random<0.15)
return 1;else if(random<0.3)
return 2;else if(random<0.45)
return 3;else if(random<0.55)
return 4;else if(random<0.65)
return 5;else if(random<0.75)
return 6;else if(random<0.8)
return 7;else if(random<0.85)
return 8;else if(random<0.9)
return 9;else if(random<0.95)
return 10;else
return 11;}
var renderItem=function(){itemContainer=new scope.Matrix();itemContainer.DrawSlotItem(slotArray);gameStage.addChild(itemContainer);}
var isLastFreeSpin=false;var showSpinResult=function(data){if(data.X2Game.StartBetValue>0){if(Config.CanPlayDouble&&!isLastFreeSpin){App.Game.UpdateLastPrize(data.X2Game.StartBetValue);}else{App.Game.UpdateLastPrize(data.SlotInfo.LastPrizeValues);}}
if(Config.IsTry){App.Game.UpdateJackpot(data.SlotInfo.Jackpot);}
if(data.Account.TotalStar>0){App.Game.UpdateBalance(App.Game.getCurrentBalance(),data.Account.TotalStar);if(data.Account.TotalStar<data.X2Game.StartBetValue){Config.CanPlayDouble=false;}}}
var checkPrize=function(data){if(data.SpinData.PayLinePrizeValue>0){if(data.SpinData.PayLinePrizeValue<Config.RoomValue*7){GameAudio.Play('Sound.MoneyRised');App.Game.ShowPrizeSmallWin(data.SpinData.PayLinePrizeValue,function(){checkFreeAndBonus(data);});}else if(data.SpinData.PayLinePrizeValue<Config.RoomValue*15){GameAudio.Play('Sound.BigWin');App.Game.ShowPrizeBigWin(data.SpinData.PayLinePrizeValue,function(){checkFreeAndBonus(data);});}else{GameAudio.Play('Sound.SuperBigWin');App.Game.ShowPrizeMegaWin(data.SpinData.PayLinePrizeValue,function(){checkFreeAndBonus(data);});}}else{checkFreeAndBonus(data);}}
var checkFreeAndBonus=function(data){if(data.SlotInfo.CanPlayBonusGame){Config.CanPlayBonus=true;App.Game.ShowBonusEffect(function(){if(!Config.IsTry){App.gameHub.server.GetBonusGame();}else{GuiContents.ShowBonusGame();}});}else if(data.SlotInfo.FreeSpins>0){if(Config.TotalFreeSpin<data.SlotInfo.FreeSpins){App.Game.ShowFreeSpinEffect(data.SlotInfo.FreeSpins,function(){GuiContents.ShowFreeSpin();Config.TotalFreeSpin=data.SlotInfo.FreeSpins;GuiContents.UpdateFreeSpin(Config.TotalFreeSpin);afterAnimation(data);});}else{Config.TotalFreeSpin=data.SlotInfo.FreeSpins;GuiContents.UpdateFreeSpin(Config.TotalFreeSpin);afterAnimation(data);}}else if(Config.TotalFreeSpin>0&&data.SlotInfo.TotalFreeSpinPrizeValue>0){isLastFreeSpin=true;GuiContents.HideFreeSpin();Config.TotalFreeSpin=data.SlotInfo.FreeSpins;afterAnimation(data);}else{GuiContents.HideFreeSpin();Config.TotalFreeSpin=0;afterAnimation(data);}}
var afterAnimation=function(data){showSpinResult(data);timeoutRepeat=setTimeout(function(){App.Game.RepeatLineWin(data,data.SpinData.PrizeLines,0);},2000);if(isLastFreeSpin){isLastFreeSpin=false;App.Game.ShowResultFreeSpin(data.X2Game.StartBetValue,function(){showSpinResult(data);Config.CurrentState=0;GuiContents.BindEvents();GuiContents.AutoSpin();});}else{Config.CurrentState=0;GuiContents.BindEvents();GuiContents.AutoSpin();}}
scope.GameLogic=gameLogic;})(window,jQuery);