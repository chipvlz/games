var ChatVQS=ChatVQS||{};(function(scope,$){var chathubLogic=function(hub){hub.server={};hub.client={};$.extend(hub.server,{pingPong:function(){return hub.invoke.apply(hub,$.merge(["PingPong"],$.makeArray(arguments)));},registerChat:function(channel){return hub.invoke.apply(hub,$.merge(["RegisterChat"],$.makeArray(arguments)));},unregisterChat:function(channel){return hub.invoke.apply(hub,$.merge(["UnregisterChat"],$.makeArray(arguments)));},sendMessage:function(message,channel){return hub.invoke.apply(hub,$.merge(["SendMessage"],$.makeArray(arguments)));}});hub.on('listUserOnlines',function(userOnlines){if(typeof userOnlines=='string')
userOnlines=$.parseJSON(userOnlines);if(typeof hub.client.listUserOnlines=='function')
hub.client.listUserOnlines(userOnlines);});hub.on('addUserOnline',function(chatUser){if(typeof chatUser=='string')
chatUser=$.parseJSON(chatUser);if(typeof hub.client.addUserOnline=='function')
hub.client.addUserOnline(chatUser);});hub.on('removeUserOnline',function(chatUser){if(typeof chatUser=='string')
chatUser=$.parseJSON(chatUser);if(typeof hub.client.removeUserOnline=='function')
hub.client.removeUserOnline(chatUser);});hub.on('systemMessage',function(systemMessage,type){if(typeof hub.client.systemMessage=='function')
hub.client.systemMessage(systemMessage,type);});hub.on('notification',function(messages){return;if(typeof hub.client.notification=='function')
hub.client.notification(messages);});hub.on('listLastMessages',function(lastMessages){if(typeof lastMessages=='string')
lastMessages=$.parseJSON(lastMessages);if(typeof ChatVQS!='undefined'&&typeof ChatVQS.listLastMessages=='function')
ChatVQS.listLastMessages(lastMessages);});hub.on('receiveMessage',function(chatMessage){if(typeof ChatVQS!='undefined'&&typeof ChatVQS.receiveMessage=='function')
ChatVQS.receiveMessage(chatMessage);});hub.on('broadcastMessage',function(messages){if(typeof ChatVQS!='undefined'&&typeof ChatVQS.broadcastMessage=='function')
ChatVQS.broadcastMessage(messages);});};scope.ChatVQSHub=chathubLogic;})(window,$);(function(scope,$){var configIdHtml={Input:'vqs_input_chat',BtnSend:'vqs_btn_send_chat',Scrollbar:'vptChatContent',Content:'vptChatContent',};var channelChat;var chatVqsLogic=function(){channelChat=ConfigVQS.ChannelChat;this.initHub();};chatVqsLogic.prototype.initHub=function(){this.connection=$.hubConnection(ConfigVQS.HubUrlChat);this.chatVqsHub=this.connection.createHubProxy(ConfigVQS.HubNameChat);var that=this;this.connection.stateChanged(function(change){if(change.newState===$.signalR.connectionState.connecting){$('#'+configIdHtml.Input).attr('placeholder','Đang kết nối...');$('#'+configIdHtml.Input).attr('disabled',true);}else if(change.newState===$.signalR.connectionState.reconnecting){$('#'+configIdHtml.Input).attr('placeholder','Đang kết nối...');$('#'+configIdHtml.Input).attr('disabled',true);}else if(change.newState===$.signalR.connectionState.connected){$('#'+configIdHtml.Input).attr('placeholder','Nhập nội dung chat...');$('#'+configIdHtml.Input).attr('disabled',false);if(!that.pingChatTimeout){that.pingChatTimeout=setInterval(function(){try{that.chatVqsHub.server.pingPong();}catch(e){}},60000);}
that.registerChat();}else if(change.newState===$.signalR.connectionState.disconnected){$('#'+configIdHtml.Input).attr('placeholder','Mất kết nối.');$('#'+configIdHtml.Input).attr('disabled',true);if(that.pingChatTimeout){clearInterval(that.pingChatTimeout);delete that.pingChatTimeout;}}});scope.ChatVQSHub(this.chatVqsHub);};chatVqsLogic.prototype.listLastMessages=function(lastMessages){$('#vptChatContent').html('');var that=this;if(lastMessages){$.each(lastMessages,function(k,v){that.receiveMessage(v);});$('.content_chat').mCustomScrollbar("scrollTo","bottom");}};chatVqsLogic.prototype.broadcastMessage=function(messages){var html='<li><p id="bxvg_chat_notitime" style="color: red;">'+messages+'</p></li>';$('#vptChatContent').append(html);$('.content_chat').mCustomScrollbar("scrollTo","bottom");setTimeout(function(){$('#bxvg_chat_notitime').remove();},2000);};chatVqsLogic.prototype.receiveMessage=function(chatMessage){if(typeof(chatMessage)!=="undefined"&&chatMessage!==null){chatMessage.ChannelId=chatMessage.i||chatMessage.ChannelId;chatMessage.AccountID=chatMessage.a||chatMessage.AccountID;chatMessage.NickName=chatMessage.n||chatMessage.AccountID;chatMessage.Content=chatMessage.c||chatMessage.Content;this.receiveMessage02(chatMessage);}};chatVqsLogic.prototype.startChat=function(){var that=this;this.startHub(function(){$('#'+configIdHtml.Input).on('keypress',function(event){if(event.which=='13'){that.sendMessage();}});$('#'+configIdHtml.BtnSend).unbind("click").bind("click",function(){that.sendMessage();});});};chatVqsLogic.prototype.registerChat=function(){var that=this;function register(){try{that.chatVqsHub.server.registerChat(channelChat).done(function(){console.log('register Chat thành công: '+channelChat);$('#'+configIdHtml.Input).attr('placeholder','Nhập nội dung chat...');$('#'+configIdHtml.Input).attr('disabled',false);});}catch(e){console.log(e);}}
if(that.connection.state==$.signalR.connectionState.connected){register();}else{that.startHub(register);}};chatVqsLogic.prototype.startHub=function(cb){try{this.connection.start({transport:ConfigVQS.Transport,jsonp:true}).done(cb());}catch(e){console.log(e);}};chatVqsLogic.prototype.unregisterChat=function(){var that=this;if(this.chatVqsHub&&this.connection&&this.connection.state==$.signalR.connectionState.connected){try{$('#'+configIdHtml.Input).attr('disabled',true);that.chatVqsHub.server.unregisterChat(channelChat).done(function(){console.log('Unregister Chat : '+channelChat);if(typeof callback=='function')
callback();});}catch(e){console.log(e);}}else{if(typeof callback=='function')
callback();}};chatVqsLogic.prototype.receiveMessage02=function(chatMessage){if(chatMessage.ChannelId!==channelChat)
return;var count=$('#'+configIdHtml.Content).children().length;if(count>30){for(var i=0;i<count-30;i++){$('#'+configIdHtml.Content+' p:nth-child(1)').remove();}}
if(typeof(chatMessage.NickName)!=="undefined"&&chatMessage.NickName!==null&&chatMessage.NickName!==''){var pEle='';if(chatMessage.AccountID==parseInt(GlobalHeader.AccountId)){pEle+='<p><b style="color: #57c34a;">'+chatMessage.n+': </b>'+chatMessage.c+'</p>';}else{pEle+='<p><b>'+chatMessage.n+': </b>'+chatMessage.c+'</p>';}
$('#vptChatContent').append(pEle);$('.content_chat').mCustomScrollbar({advanced:{updateOnContentResize:true}});$('.content_chat').mCustomScrollbar("scrollTo","bottom");}};chatVqsLogic.prototype.sendMessage=function(){if(!vqsSlot.checkLogin()){GlobalHeader.ShowLoginPopup(1);}else{var that=this;var msg=$('#'+configIdHtml.Input).val();if(msg&&msg!=''&&msg.length<=512){if(this.chatVqsHub&&this.connection&&(this.connection.state===$.signalR.connectionState.connected)){try{that.chatVqsHub.server.sendMessage(msg,channelChat).done(function(success){if(success){$('#'+configIdHtml.Input).val('');}});}catch(e){console.log(e);}}else{this.startHub(function(){try{that.chatVqsHub.server.registerChat(channelChat).done(function(){that.chatVqsHub.server.sendMessage(msg,channelChat).done(function(success){if(success){$('#'+configIdHtml.Input).val('');}});});}catch(e){console.log(e);}});}}}};scope.ChatVQSLogic=chatVqsLogic;})(window,$);$(document).ready(function(){ChatVQS=new window.ChatVQSLogic();ChatVQS.startChat();setTimeout(function(){ChatVQS.registerChat();},3000);});